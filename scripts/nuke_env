#!/usr/bin/env bash
# Nuke the entire environment and start fresh
# WARNING: This will delete all database data and volumes!

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

cd "$PROJECT_ROOT"

echo "‚ö†Ô∏è  WARNING: DESTRUCTIVE OPERATION ‚ö†Ô∏è"
echo ""
echo "This script will:"
echo "  ‚Ä¢ Stop all Mercury containers"
echo "  ‚Ä¢ Remove all containers"
echo "  ‚Ä¢ Delete all volumes (including database data)"
echo "  ‚Ä¢ Remove all images"
echo "  ‚Ä¢ Start fresh containers"
echo ""
echo "üî• ALL DATABASE DATA WILL BE PERMANENTLY DELETED! üî•"
echo ""
read -p "Are you absolutely sure you want to continue? (type 'yes' to confirm): " confirmation

if [ "$confirmation" != "yes" ]; then
    echo ""
    echo "‚ùå Operation cancelled. Nothing was changed."
    exit 0
fi

echo ""
echo "üí• Nuking the environment..."
echo ""

echo "1Ô∏è‚É£  Stopping containers..."
docker-compose down

echo "2Ô∏è‚É£  Removing containers..."
docker-compose rm -f

echo "3Ô∏è‚É£  Removing volumes (this deletes all data)..."
docker-compose down -v

echo "4Ô∏è‚É£  Removing images..."
docker-compose down --rmi all || echo "   Note: Some images may still be in use"

echo "5Ô∏è‚É£  Starting fresh containers..."
docker-compose up -d --build

echo ""
echo "‚úÖ Environment nuked and rebuilt successfully!"
echo ""
echo "Services available at:"
echo "  Frontend:  http://localhost:3000"
echo "  Backend:   http://localhost:8080"
echo "  Database:  localhost:5432 (fresh, empty database)"
echo ""
echo "Note: You're starting with a completely fresh database."

